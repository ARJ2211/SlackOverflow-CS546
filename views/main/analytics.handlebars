<div onclick="handleOutsideClick(event)" class="w-full h-full px-6 py-4">
  <!-- Page Header -->
  <div class="flex items-center justify-between mb-4 border-b pb-2">
    <div>
      <h1 class="text-xl font-semibold text-gray-800">
        {{title}}
      </h1>
      <p class="text-gray-400 text-sm flex items-center gap-1">
        <a href="/">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
               fill="currentColor" class="size-4 hover:text-[#F0BD66]">
            <path fill-rule="evenodd"
                  d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z"
                  clip-rule="evenodd" />
          </svg>
        </a>
        {{path}}
      </p>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3">
      <!-- Course filter -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-500">Course</span>
        <select
          id="courseFilter"
          class="bg-white border border-gray-300 text-sm text-gray-800 px-3 py-1.5 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[#F0BD66]/70 focus:border-[#F0BD66]"
        >
          <option value="all" {{#if (eq selectedCourse "all")}}selected{{/if}}>
            Select Course
          </option>
          {{#each courses}}
            <option value="{{this._id}}" {{#if (eq ../selectedCourse this._id)}}selected{{/if}}>
              {{this.course_id}} · {{this.course_name}}
            </option>
          {{/each}}
        </select>
      </div>

      <!-- Time range -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-500">Time range</span>
        <select
          id="timeRange"
          class="bg-white border border-gray-300 text-sm text-gray-800 px-3 py-1.5 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[#F0BD66]/70 focus:border-[#F0BD66]"
        >
          <option value="7d"  {{#if (eq selectedRange "7d")}}selected{{/if}}>Last 7 days</option>
          <option value="30d" {{#if (eq selectedRange "30d")}}selected{{/if}}>Last 30 days</option>
          <option value="90d" {{#if (eq selectedRange "90d")}}selected{{/if}}>Last 90 days</option>
          <option value="all" {{#if (eq selectedRange "all")}}selected{{/if}}>All time</option>
        </select>
      </div>

      <!-- Refresh -->
      <button
        id="refreshAnalytics"
        class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full text-gray-700 border border-gray-300 bg-white hover:bg-gray-50 shadow-sm transition-colors"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Refresh
      </button>
    </div>
  </div>

  {{!-- DASHBOARD CONTAINER (always rendered, visibility toggled by JS + initial flag) --}}
  <div
    id="analyticsContainer"
    class="{{#if hasSelectedCourse}}flex{{else}}hidden{{/if}} flex-1 flex-col h-[calc(100vh-150px)] w-full"
  >
    <!-- Outer card, fixed to the available height -->
    <div class="h-full w-full rounded-2xl bg-white shadow-sm border border-gray-200 flex flex-col">
      <!-- Scrollable content inside the card -->
      <div class="p-4 flex-1 flex flex-col gap-3 overflow-y-auto">
        <!-- TOP SUMMARY CARDS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-2 mb-3">
          <!-- Total TAs -->
          <div class="rounded-2xl border border-amber-100 bg-gradient-to-br from-white to-[#FFF9EB] p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total TAs</span>
              <span class="text-[11px] text-[#D89A3D] inline-flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                Active overview
              </span>
            </div>
            <div class="mt-3 flex items-end justify-between">
              <span id="totalTaCount" class="text-2xl md:text-3xl font-semibold text-gray-900">0</span>
              <span id="taActiveCourses" class="text-xs text-gray-600">Across 0 courses</span>
            </div>
          </div>

          <!-- Students -->
          <div class="rounded-2xl border border-blue-100 bg-gradient-to-br from-white to-[#EFF6FF] p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Students</span>
              <span class="text-[11px] text-blue-500">Question volume</span>
            </div>
            <div class="mt-3 flex items-end justify-between gap-4">
              <div>
                <p id="totalStudentCount" class="text-2xl md:text-3xl font-semibold text-gray-900">0</p>
                <p class="text-xs text-gray-600 mt-0.5">Unique students</p>
              </div>
              <div class="text-right">
                <p id="totalQuestionCount" class="text-xl font-semibold text-gray-900">0</p>
                <p class="text-xs text-gray-600 mt-0.5">Total questions</p>
              </div>
            </div>
          </div>

          <!-- Unanswered -->
          <div class="rounded-2xl border border-rose-100 bg-gradient-to-br from-white to-[#FEF2F2] p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Unanswered</span>
                <span class="block text-[11px] text-rose-500">Backlog</span>
              </div>
              <!-- Dynamic unanswered link -->
              <button
                id="viewUnansweredBtn"
                class="inline-flex items-center gap-1.5 text-[11px] px-2.5 py-1 rounded-full text-rose-700 border border-rose-200 bg-white hover:bg-rose-50 transition-colors opacity-50 cursor-not-allowed"
                disabled
              >
                <span>View unanswered list</span>
              </button>
            </div>
            <div class="mt-3 flex items-end justify-between gap-4">
              <div>
                <p id="unansweredCount" class="text-2xl md:text-3xl font-semibold text-rose-600">0</p>
                <p class="text-xs text-gray-600 mt-0.5">Need attention</p>
              </div>
              <div class="text-right space-y-1">
                <p id="unansweredPercent" class="text-xs text-gray-600">0% of all questions</p>
                <div class="w-24 h-1.5 rounded-full bg-rose-100 overflow-hidden">
                  <div id="unansweredBar" class="h-full bg-rose-500" style="width: 0%;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Avg Response Time -->
          <div class="rounded-2xl border border-emerald-100 bg-gradient-to-br from-white to-[#ECFDF3] p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Avg response time</span>
              <span class="text-[11px] text-emerald-600">TA replies</span>
            </div>
            <div class="mt-3">
              <p id="avgResponseTime" class="text-2xl md:text-3xl font-semibold text-gray-900">—</p>
              <p class="text-xs text-gray-600 mt-0.5">For this course</p>
            </div>
          </div>
        </div>

        <!-- TA analytics + Per-course activity -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 mb-3">
          <!-- TA Analytics Table -->
          <div class="xl:col-span-2 rounded-2xl border border-gray-200 bg-[#F9FAFF] shadow-sm flex flex-col">
            <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-gray-900">TA analytics</p>
                <p class="text-xs text-gray-500">Performance for this course in the selected time range.</p>
              </div>
              <span class="text-[11px] text-gray-500">All TA activity</span>
            </div>
            <div class="overflow-x-auto h-64 overflow-y-auto">
              <table class="min-w-full text-left text-xs text-gray-700">
                <thead class="bg-white border-b border-gray-200 text-[11px] uppercase text-gray-500 sticky top-0">
                  <tr>
                    <th class="py-2.5 px-4 bg-white">TA</th>
                    <th class="py-2.5 px-4 bg-white">Questions answered</th>
                    <th class="py-2.5 px-4 bg-white">Avg response time</th>
                    <th class="py-2.5 px-4 bg-white">Last active</th>
                  </tr>
                </thead>
                <tbody id="taAnalyticsTableBody" class="divide-y divide-gray-100 bg-white">
                  <tr class="hover:bg-gray-50">
                    <td class="py-2.5 px-4">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- TA Activity by Course -->
          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm flex flex-col">
            <div class="px-4 py-3 border-b border-gray-200">
              <p class="text-sm font-semibold text-gray-900">TA activity per course</p>
              <p class="text-xs text-gray-500">How TA answers are distributed across your courses.</p>
            </div>
            <div id="taActivityPerCourseList" class="p-4 flex flex-col gap-3 h-64 overflow-y-auto">
              <p class="text-xs text-gray-500">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Student activity + Trending labels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <!-- Student Activity -->
          <div class="lg:col-span-2 rounded-2xl border border-gray-200 bg-white shadow-sm flex flex-col">
            <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-gray-900">Student activity</p>
                <p class="text-xs text-gray-500">Students asking the most questions.</p>
              </div>
              <span class="text-[11px] text-gray-500">Top 10 students</span>
            </div>
            <div class="overflow-x-auto h-48 overflow-y-auto">
              <table class="min-w-full text-left text-xs text-gray-700">
                <thead class="bg-[#F9FAFB] border-b border-gray-200 text-[11px] uppercase text-gray-500 sticky top-0">
                  <tr>
                    <th class="py-2.5 px-4 bg-[#F9FAFB]">Student</th>
                    <th class="py-2.5 px-4 bg-[#F9FAFB]">Course</th>
                    <th class="py-2.5 px-4 bg-[#F9FAFB]">Questions asked</th>
                    <th class="py-2.5 px-4 bg-[#F9FAFB]">Answered</th>
                    <th class="py-2.5 px-4 bg-[#F9FAFB]">Last question</th>
                  </tr>
                </thead>
                <tbody id="studentActivityTableBody" class="divide-y divide-gray-100 bg-white">
                  <tr class="hover:bg-gray-50">
                    <td class="py-2.5 px-4">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Trending Labels -->
          <div class="rounded-2xl border border-gray-200 bg-[#FDFBF6] shadow-sm flex flex-col">
            <div class="px-4 py-3 border-b border-amber-100">
              <p class="text-sm font-semibold text-gray-900">Trending labels</p>
              <p class="text-xs text-gray-500">Topics with the most activity.</p>
            </div>
            <div
              id="trendingLabelsCloud"
              class="p-3 flex flex-wrap items-start gap-1.5 h-40 overflow-y-auto"
            >
              <p class="text-xs text-gray-500">Loading...</p>
            </div>
            <div class="mt-auto px-4 py-2 border-t border-amber-100">
              <p class="text-[11px] text-gray-500">
                Based on label usage in the selected time range.
              </p>
            </div>
          </div>
        </div>
      </div> <!-- end p-4 flex-1 -->
    </div>   <!-- end card -->
  </div>     <!-- end analyticsContainer -->

  {{!-- EMPTY STATE (also always rendered, toggled by same flag + JS) --}}
  <div
    id="analyticsEmptyState"
    class="{{#if hasSelectedCourse}}hidden{{else}}flex{{/if}} flex-1 flex-col items-center justify-center h-[calc(100vh-150px)] w-full text-gray-400"
  >
    <img
      src="/public/images/emptyContent.png"
      alt="No course selected"
      class="w-64 mb-4 opacity-90"
    />
    <p class="text-lg font-medium text-gray-700">
      Select a course to see analytics
    </p>
    <p class="text-sm text-gray-500 mt-1">
      Once you choose a course, TA and student activity will show up here.
    </p>
  </div>

  <script src="/public/js/analytics.js"></script>
</div>
